package com.example.tugasakhir.ui.result

import android.net.Uri
import android.os.Bundle
import android.util.Log
import android.widget.Toast
import androidx.appcompat.app.AppCompatActivity
import androidx.lifecycle.lifecycleScope
import com.example.tugasakhir.R
import com.example.tugasakhir.database.History
import com.example.tugasakhir.database.HistoryDatabase
import com.example.tugasakhir.databinding.ActivityResultBinding
import com.example.tugasakhir.helper.ImageClassifierHelper
import kotlinx.coroutines.Dispatchers
import kotlinx.coroutines.launch
import kotlinx.coroutines.withContext
import org.json.JSONObject
import java.io.File
import java.io.FileOutputStream
import java.io.InputStream
import java.text.SimpleDateFormat
import java.util.Date
import java.util.Locale



class ResultActivity : AppCompatActivity() {
    private lateinit var binding: ActivityResultBinding
    private lateinit var recommendationsJson: JSONObject

    private var currentLabel: String = ""
    private var currentDescription: String = ""
    private var currentImageUri: Uri? = null


    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        binding = ActivityResultBinding.inflate(layoutInflater)
        setContentView(binding.root)

        // Load recommendations.json from assets (expected structure: { "ripe": { "title": "...", "description": "...", "recommendation": "..." }, ... })
        loadRecommendations()

        val imageUriString = intent.getStringExtra(EXTRA_IMAGE_URI)
        if (imageUriString == null) {
            Log.e(TAG, "No image URI provided")
            Toast.makeText(this, getString(R.string.empty_image_warning), Toast.LENGTH_SHORT).show()
            finish()
            return
        }

        val imageUri = Uri.parse(imageUriString)
        currentImageUri = imageUri
        showImage(imageUri)

        // Instantiate helper: ensure model + labels are present in assets
        val imageClassifierHelper = ImageClassifierHelper(
            context = this,
            modelFileName = "best_banana_ripeness_model.tflite",        // pastikan ada di assets/
            labelsFileName = "best_banana_ripeness_labels.txt",         // pastikan ada di assets/
            inputSize = 224,
            numThreads = 4,
            maxResults = 4,
            classifierListener = object : ImageClassifierHelper.ClassifierListener {
                override fun onError(error: String) {
                    Log.e(TAG, "Classifier error: $error")
                    runOnUiThread {
                        binding.textCategory.text = error
                        Toast.makeText(this@ResultActivity, error, Toast.LENGTH_SHORT).show()

                    }
                }

                // New signature from Interpreter-based helper
                override fun onResultsSimple(results: List<Pair<String, Float>>, inferenceTime: Long) {
                    runOnUiThread {
                        handleResultsSimple(results, inferenceTime)
                    }

                }
            }
        )

        // Run classification
        imageClassifierHelper.classifyImage(imageUri)

        binding.btnSave.setOnClickListener {
            if (currentLabel.isBlank() || currentImageUri == null) {
                showToast(getString(R.string.invalid_result))
                return@setOnClickListener
            }
            saveHistory(currentImageUri!!)
        }
    }

    // ---------- UI helpers ----------
    private fun showImage(uri: Uri) {
        binding.resultImage.setImageURI(uri)
    }

    // Handle results in format List<Pair<label,score>>
    private fun handleResultsSimple(results: List<Pair<String, Float>>, inferenceTime: Long) {
        if (results.isEmpty()) {
            binding.textRecomendationDescription.text =
                getString(R.string.no_banana_ripeness_detected)
            return
        }

        val top = results[0]
        val labelRaw = top.first.trim()
        val score = top.second

        val displayLabel = labelRaw.replaceFirstChar {
            if (it.isLowerCase()) it.titlecase(Locale.getDefault()) else it.toString()
        }

        currentLabel = displayLabel
        binding.textCategory.text = displayLabel
        binding.textAccuracy.text =
            getString(R.string.confidence_label, score * 100)

        showRecommendationForLabel(labelRaw)
    }


    // ---------- recommendations.json helpers ----------
    private fun loadRecommendations() {
        recommendationsJson = try {
            val input: InputStream = assets.open("recommendations.json")
            val jsonText = input.bufferedReader().use { it.readText() }
            JSONObject(jsonText)
        } catch (e: Exception) {
            Log.e(TAG, "Failed to load recommendations.json: ${e.message}")
            JSONObject()
        }
    }

    private fun showRecommendationForLabel(label: String) {
        try {
            // Expecting each key maps to object { "title": "...", "description": "...", "recommendation": "..." }
            val key = label.lowercase(Locale.getDefault())
            if (!recommendationsJson.has(key)) {
                binding.textRecomendationDescription.text = getString(R.string.recommendation_not_found)
                return
            }
            val obj = recommendationsJson.getJSONObject(key)
            // Prefer title + recommendation combined; adapt to your layout
            val title = obj.optString("title").takeIf { it.isNotBlank() } ?: key.replaceFirstChar { it.uppercaseChar() }
            val desc = obj.optString("description").takeIf { it.isNotBlank() } ?: ""
            val reco = obj.optString("recommendation").takeIf { it.isNotBlank() } ?: ""

            // Compose display text
            val builder = StringBuilder()
            builder.append(title)
//            builder.append("\n\n").append(binding.textCategory.text).append(":").append(title)
            if (desc.isNotBlank()) {
                builder.append("\n\n").append(getString(R.string.description)).append(":\n").append(desc)
//                builder.append("\n\n").append(desc)
            }
            if (reco.isNotBlank()) {
                builder.append("\n\n").append(getString(R.string.recommendation_title)).append(":\n").append(reco)
            }

            binding.textRecomendationDescription.text = builder.toString()
            currentDescription = builder.toString()
        } catch (e: Exception) {
            Log.e(TAG, "Error parsing recommendation for '$label': ${e.message}")
            binding.textRecomendationDescription.text = getString(R.string.recommendation_not_found)
        }
    }



    // ---------- Persist history ----------
    private fun saveHistory(sourceUri: Uri) {
        lifecycleScope.launch {
            try {
                val fileName = "history_${System.currentTimeMillis()}.jpg"
                val destFile = File(filesDir, fileName)

                withContext(Dispatchers.IO) {
                    contentResolver.openInputStream(sourceUri)?.use { input ->
                        FileOutputStream(destFile).use { output ->
                            input.copyTo(output)
                        }
                    }

                    val history = History(
                        imagePath = destFile.absolutePath,
                        label = currentLabel,
                        description = currentDescription,
                        createdAt = SimpleDateFormat(
                            "yyyy-MM-dd HH:mm",
                            Locale.getDefault()
                        ).format(Date())
                    )

                    HistoryDatabase
                        .getDatabase(applicationContext)
                        .historyDao()
                        .insertHistory(history)
                }

                showToast(getString(R.string.data_saved_success))
                finish()

            } catch (e: Exception) {
                Log.e(TAG, "Save history failed", e)
                showToast(getString(R.string.data_save_failed))
            }
        }
    }



//    private fun moveToHistory(imageUri: Uri, result: String) {
//        val intent = Intent(requireActivity(), HistoryFragment::class.java) // pastikan HistoryActivity ada dan terdaftar
//        intent.putExtra(EXTRA_IMAGE_URI, imageUri.toString())
//        intent.putExtra(EXTRA_RESULT, result)
//        startActivity(intent)
//        finish()
//    }

    // ---------- utils ----------
    private fun Float.formatToPercentString(): String = String.format(Locale.getDefault(), "%.2f%%", this * 100)
    private fun showToast(msg: String) = Toast.makeText(this, msg, Toast.LENGTH_SHORT).show()

    companion object {
        const val EXTRA_IMAGE_URI = "extra_image_uri"
        const val EXTRA_RESULT = "extra_result"
        const val TAG = "ResultActivity"
    }
}